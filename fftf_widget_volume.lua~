--音量控制插件
-- 参考修改自http://awesome.naquadah.org/wiki/Farhavens_volume_widget
local awful = require("awful")
local wibox = require("wibox")
local volume_icons = require("volume_icons")

-- widget 界面
fftf_widget_volume = {}
fftf_widget_volume.icon = wibox.widget.imagebox()
fftf_widget_volume.text = wibox.widget.textbox()
-- fftf_widget_volume:set_image("/usr/share/icons/ubuntu-mono-dark/status/24/audio-volume-low-panel.svg")
-- 音量控制调节函数
cardid  = 1
channel = "Master"
voicebak = "0"
isNotInit = false
function fftf_widget_volume_control_vol(mode, widget)
   local status = io.popen("amixer -c " .. cardid .. " -- sget " .. channel):read("*all")
   volumedata = string.match(status, "(%d?%d?%d)%%")
   if mode == "update" then
      local ic = ""

      local v = tonumber(volumedata)
      local tx =  " " .. v .. "% "
      if v==0 then
	 if state=="muted" then
	    ic = volume_icons_muted
	    tx = "Mut"-- fftf_widget_volume.text:set_text("Muted")
	 else 
	    ic = volume_icons_zero
	 end
      elseif v<=33 then
	 ic = volume_icons_low	--
      elseif v<=66 then
	 ic = volume_icons_medium 
      else
	 ic = volume_icons_high
      end
      fftf_widget_volume.icon:set_image(ic)
      fftf_widget_volume.text:set_text(tx)
   elseif mode == "up" then
      state = "up"
      isNotInit = true
      voicebak = volumedata
      
      awful.util.spawn("amixer -q -c " .. cardid .. " sset " .. channel .. " 5%+")
      fftf_widget_volume_control_vol("update", widget)
   elseif mode == "down" then
      state = "down"
      voicebak = volumedata
      
      isNotInit = true
      awful.util.spawn("amixer -q -c " .. cardid .. " sset " .. channel .. " 5%-")
      fftf_widget_volume_control_vol("update", widget)
   elseif mode=="mute" and volumedata=="0" and isNotInit then
      state = "umuted"
      awful.util.spawn("amixer -q -c " .. cardid .. " sset " .. channel .. " " .. voicebak .. "%")
      fftf_widget_volume_control_vol("update", widget)
   else
      isNotInit = true
      voicebak = volumedata
      state = "muted"
      awful.util.spawn("amixer -q -c " .. cardid .. " sset " .. channel .. " 0%")
      fftf_widget_volume_control_vol("update", widget)
   end
end

fftf_widget_volume_control_vol("update", fftf_widget_volume)

-- 时间刷新hook, 完全没必要
volume_timer = timer { timeout = 1 }
volume_timer:connect_signal("timeout", function() fftf_widget_volume_control_vol("update", fftf_widget_volume) end)
volume_timer:start()		
